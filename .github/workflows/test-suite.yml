name: Bot Full Test Suite

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    paths-ignore:
      - 'docs/**'
      - '.github/workflows/codeql-analysis.yml'
      - '.github/workflows/DesignSecurity.yml'
      - '.github/workflows/phan.yml'
      - '.github/workflows/PHPChecker.yml'
      - '.github/workflows/phplint.yml'
      - '.github/workflows/phpstan.yml'
      - '.github/workflows/psalm-security.yml'
      - '.github/workflows/psalm.yml'
      - '.github/workflows/size-limit.yml'
      - '.github/workflows/ThePHPChecker.yml'
      - '.github/workflows/trivy-analysis.yml'
      - '.github/workflows/YamlJson.yml'
      - '.github/workflows/html5check.yml'
      - '.github/workflows/PHPCodeSniffer.yml'
      - '.gitignore'
      - '.phan'
      - '.phan/config.php'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - 'index.html'
      - 'LICENSE'
      - 'phpstan.neon'
      - 'progpilot.json'
      - 'progpilot.yml'
      - 'psalm.xml'
      - '.trivyignore'
      - '.phpcs.xml'
      - '.phplint.yml'
      - 'tests/phpunit/README.md'
      - 'AGENTS.md'
      - 'CITATION.cff'
      - '.markdownlint-cli2.yaml'
      - '.github/dependabot.yml'
      - 'src/assets/results.css'
      - 'src/assets/index.js'
      - 'src/index.html'

  schedule:
    - cron: '25 17 * * 1'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:

    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v6.0.2

    - name: Setup PHP with PCOV
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        ini-values: pcov.directory=., opcache.enable=1, opcache.enable_cli=1, opcache.jit_buffer_size=0
        coverage: pcov
        extensions: mbstring, intl, sockets, opcache, openssl, xmlrpc, gettext, curl, iconv, pcre, lzf, zstd, zip, yaml, pcntl
        # Performance optimizations for faster test execution:
        # - opcache.enable=1, opcache.enable_cli=1: Enable opcache for CLI to cache compiled PHP code
        # - opcache.jit_buffer_size=0: Explicitly disable JIT (incompatible with pcov - both override zend_execute_ex)
        # These settings provide modest speedup while maintaining code coverage capabilities

    - name: Validate composer.json and composer.lock
      run: composer validate

    - name: Install dependencies
      run: composer install -vvv --no-progress
      # Verbose logging (-vvv) adds ~5-15 seconds overhead due to detailed package resolution output
      # Keeping verbose for better debugging visibility

    - name: Full test with PHP
      env:
         PHP_ADSABSAPIKEY: ${{ secrets.PHP_ADSABSAPIKEY }}
         PHP_OAUTH_CONSUMER_TOKEN: ${{ secrets.PHP_OAUTH_CONSUMER_TOKEN }}
         PHP_OAUTH_CONSUMER_SECRET: ${{ secrets.PHP_OAUTH_CONSUMER_SECRET }}
         PHP_OAUTH_ACCESS_TOKEN: ${{ secrets.PHP_OAUTH_ACCESS_TOKEN }}
         PHP_OAUTH_ACCESS_SECRET: ${{ secrets.PHP_OAUTH_ACCESS_SECRET }}
         PHP_WP_OAUTH_SECRET: ${{ secrets.PHP_WP_OAUTH_SECRET }}
         PHP_WP_OAUTH_CONSUMER: ${{ secrets.PHP_WP_OAUTH_CONSUMER }}
         PHP_S2APIKEY: ${{ secrets.PHP_S2APIKEY }}
      run: composer run test

    - name: Manually look for weird stuff
      if: always()
      run: /bin/cat ./src/includes/CodeCoverage

    - name: Code Coverage
      if:  ${{ !cancelled() && github.event_name != 'pull_request' }}
      uses: codecov/codecov-action@v5.5.2
      env:
         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

